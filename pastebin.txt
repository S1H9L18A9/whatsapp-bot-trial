#!/usr/bin/env python3
import fcntl
import time
import random
import os
from datetime import datetime

def safe_add_line(filename, line, max_retries=10):
    """Safely add a line to file with file locking"""
    for attempt in range(max_retries):
        try:
            with open(filename, 'a') as f:
                fcntl.flock(f.fileno(), fcntl.LOCK_EX | fcntl.LOCK_NB)
                f.write(line + '\n')
                f.flush()
                print(f"[WRITER] Added line: {line}")
                return True
                
        except (IOError, OSError) as e:
            print(f"[WRITER] Attempt {attempt + 1}: File locked, retrying...")
            time.sleep(0.1 + attempt * 0.05)
            continue
    
    print(f"[WRITER] FAILED to write: {line}")
    return False

def main():
    filename = "shared_queue.txt"
    
    print("[WRITER] Starting - will add folder names every 2-5 seconds")
    
    folder_counter = 1
    
    while folder_counter <= 50:  # Add 50 folders total
        # Create folder name
        folder_name = f"stage1_{folder_counter:03d}"
        
        # Add to queue file
        safe_add_line(filename, folder_name)
        
        folder_counter += 1
        
        # Random delay between additions (2-5 seconds)
        delay = random.uniform(2.0, 5.0)
        print(f"[WRITER] Waiting {delay:.1f}s before next folder...")
        time.sleep(delay)
    
    print("[WRITER] Finished adding all folders")

if __name__ == "__main__":
    main()
